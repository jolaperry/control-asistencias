<table class="calendar-table">
    <thead>
        <tr>
            <th class="sticky-service">Servicio</th>
            <th class="sticky-name">Apellidos y nombres</th>
            {% for dia in dias %}
                <th class="day-header">
                    <span>{{ dias_semana_abrev[loop.index0] }}</span>
                    <span>{{ dia }}</span>
                </th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% set current_servicio = "" %}
        {% for rut, empleado in calendario.items() %}
            {% if empleado.servicio != current_servicio %}
                {% if current_servicio != "" %}
                    <tr class="service-separator"><td colspan="{{ 2 + dias|length }}"></td></tr>
                {% endif %}
                <tr class="service-group-header">
                    <td colspan="{{ 2 + dias|length }}">{{ empleado.servicio }}</td>
                </tr>
                {% set current_servicio = empleado.servicio %}
            {% endif %}
        <tr>
            <td class="service-cell">{{ empleado.servicio }}</td>
            <td class="name-cell">{{ empleado.nombre_completo }}</td>
            {% for dia in dias %}
                <td class="day-cell">
                    {% set asistencia_dia = empleado.asistencias.get(dia) %}
                    {% if asistencia_dia %}
                        {% set estado_class = asistencia_dia.estado | lower | replace(' ', '-') %}
                        <a href="{{ url_for('editar_asistencia_calendario', id_asistencia=asistencia_dia.id_asistencia, anio=anio, mes=mes_numero) }}" class="{{ estado_class }}" title="Comentario: {{ asistencia_dia.comentario }}">
                            {{ asistencia_dia.estado }}
                            {% if asistencia_dia.comentario %}
                                <span class="comment-icon" title="{{ asistencia_dia.comentario }}">üí¨</span>
                            {% endif %}
                        </a>
                    {% else %}
                        <a href="#" class="no-registro open-modal" data-rut="{{ rut }}" data-dia="{{ dia }}" data-mes="{{ mes_numero }}" data-anio="{{ anio }}">
                            <span class="plus-sign">+</span>
                        </a>
                    {% endif %}
                </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="asistencia_modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Registrar Asistencia</h2>
        <form id="asistencia_form">
            <label for="modal-rut">RUT:</label>
            <input type="text" id="modal-rut" name="RUT" readonly>
            
            <label for="modal-fecha">Fecha:</label>
            <input type="date" id="modal-fecha" name="fecha" readonly>
            
            <label for="modal-estado">Estado:</label>
            <select id="modal-estado" name="estado">
                <option value="P">Presente (P)</option>
                <option value="DL">D√≠a libre (DL)</option>
                <option value="PE">Permisos Especiales/legales (PE)</option>
                <option value="V">Vacaciones (V)</option>
                <option value="CAP">D√≠as capacitaci√≥n ingreso (CAP)</option>
                <option value="A">Ausencia (A)</option>
                <option value="L">Licencia M√©dica (L)</option>
                <option value="R">Renuncia/Desvinculaci√≥n (R)</option>
            </select>

            <label for="modal-comentario">Comentario:</label>
            <textarea id="modal-comentario" name="comentario"></textarea>
            
            <label for="modal-hora-entrada">Hora de Entrada (opcional):</label>
            <input type="time" id="modal-hora-entrada" name="hora_entrada">

            <label for="modal-hora-salida">Hora de Salida (opcional):</label>
            <input type="time" id="modal-hora-salida" name="hora_salida">
            
            <button type="submit">Guardar Registro</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const modal = document.getElementById("asistencia_modal");
        const closeBtn = document.getElementsByClassName("close-btn")[0];
        const form = document.getElementById('asistencia_form');

        function setupModalListeners() {
            // Eliminar listeners antiguos para evitar duplicados
            const oldLinks = document.querySelectorAll('.open-modal');
            oldLinks.forEach(link => {
                const newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);
            });

            // Muestra el modal al hacer clic en un enlace de '+'
            document.querySelectorAll('.open-modal').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    var rut = this.getAttribute('data-rut');
                    var dia = this.getAttribute('data-dia');
                    var mes = this.getAttribute('data-mes');
                    var anio = this.getAttribute('data-anio');

                    var mes_formato = String(mes).padStart(2, '0');
                    var dia_formato = String(dia).padStart(2, '0');
                    var fecha_str = `${anio}-${mes_formato}-${dia_formato}`;

                    document.getElementById('modal-rut').value = rut;
                    document.getElementById('modal-fecha').value = fecha_str;
                    modal.style.display = "block";
                });
            });
        }
        
        // Cierra el modal
        closeBtn.onclick = function() {
            modal.style.display = "none";
        };

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        };

        // Manejar el env√≠o del formulario de asistencia
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            var rut = document.getElementById('modal-rut').value;
            var fecha = document.getElementById('modal-fecha').value;
            var estado = document.getElementById('modal-estado').value;
            var comentario = document.getElementById('modal-comentario').value;
            var hora_entrada = document.getElementById('modal-hora-entrada').value;
            var hora_salida = document.getElementById('modal-hora-salida').value;

            fetch('/registrar_asistencia_ajax', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    RUT: rut,
                    fecha: fecha,
                    estado: estado,
                    comentario: comentario,
                    hora_entrada: hora_entrada,
                    hora_salida: hora_salida
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var anio = fecha.split('-')[0];
                    var mes = fecha.split('-')[1];
                    const url = `/calendario/${anio}/${parseInt(mes)}`;
                    
                    fetch(url, {
                        headers: {
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    })
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById("contenedor-tabla").innerHTML = html;
                        modal.style.display = "none";
                        setupModalListeners(); // Vuelve a adjuntar los listeners
                    });
                } else {
                    alert('Error al registrar la asistencia.');
                }
            });
        });

        // Configurar los listeners al cargar la p√°gina inicialmente
        setupModalListeners();
    });
</script>
