<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario - {{ mes }} {{ anio }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>Asistencias - {{ mes }} {{ anio }}</h1>
        <nav>
            <a href="{{ url_for('seleccionar_mes') }}" class="back-button">Seleccionar Otro Mes</a>
        </nav>
    </header>

    <main>
        <table>
            <thead>
                <tr>
                    <th rowspan="2">Nombre</th>
                    <th rowspan="2">Servicio</th>
                    <th colspan="{{ dias|length }}"></th>
                </tr>
                <tr>
                    {% for dia in dias %}
                    <th class="dia-semana">{{ dias_semana_abrev[loop.index0] }}<br>{{ dia }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for rut, empleado in calendario.items() %}
                {% set siguiente_empleado = loop.nextitem %}
                <tr {% if siguiente_empleado and siguiente_empleado[1].servicio != empleado.servicio %}class="group-end-row"{% endif %}>
                    <td>{{ empleado.nombre_completo }}</td>
                    <td>{{ empleado.servicio }}</td>
                    {% for dia in dias %}
                    <td>
                        {% if dia in empleado.asistencias %}
                            <a href="{{ url_for('editar_asistencia_calendario', id_asistencia=empleado.asistencias[dia].id_asistencia, anio=anio, mes=mes_numero) }}" class="estado-{{ empleado.asistencias[dia].estado | replace(' ', '_') | replace('/', '_') | lower }}">
                                {% if empleado.asistencias[dia].comentario %}
                                    <span class="has-comment" title="{{ empleado.asistencias[dia].comentario }}">ðŸ’¬</span>
                                {% endif %}
                                {% if empleado.asistencias[dia].estado == 'Presente' %} P
                                {% elif empleado.asistencias[dia].estado == 'DÃ­a libre' %} DL
                                {% elif empleado.asistencias[dia].estado == 'Permisos Especiales/legales' %} PE
                                {% elif empleado.asistencias[dia].estado == 'Vacaciones' %} V
                                {% elif empleado.asistencias[dia].estado == 'DÃ­as capacitaciÃ³n ingreso' %} CAP
                                {% elif empleado.asistencias[dia].estado == 'Ausencia' %} A
                                {% elif empleado.asistencias[dia].estado == 'Licencia MÃ©dica' %} L
                                {% elif empleado.asistencias[dia].estado == 'Renuncia/DesvinculaciÃ³n' %} R
                                {% else %} {{ empleado.asistencias[dia].estado }}
                                {% endif %}
                            </a>
                        {% else %}
                            <a href="#" class="estado-ninguno open-dropdown" data-rut="{{ rut }}" data-dia="{{ dia }}" data-mes="{{ mes_numero }}" data-anio="{{ anio }}">+</a>
                            <div class="dropdown-menu">
                                <form class="asistencia-form" data-rut="{{ rut }}" data-dia="{{ dia }}" data-mes="{{ mes_numero }}" data-anio="{{ anio }}">
                                    <label for="estado">Estado:</label>
                                    <select name="estado" required>
                                        <option value="Presente">P</option>
                                        <option value="DÃ­a libre">DL</option>
                                        <option value="Permisos Especiales/legales">PE</option>
                                        <option value="Vacaciones">V</option>
                                        <option value="DÃ­as capacitaciÃ³n ingreso">CAP</option>
                                        <option value="Ausencia">A</option>
                                        <option value="Licencia MÃ©dica">L</option>
                                        <option value="Renuncia/DesvinculaciÃ³n">R</option>
                                    </select>
                                    <br>
                                    <label for="comentario">Comentario:</label>
                                    <input type="text" name="comentario" placeholder="Motivo de la asistencia">
                                    <br>
                                    <button type="submit">Guardar</button>
                                </form>
                            </div>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.open-dropdown').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
                        if (menu !== link.nextElementSibling && menu.classList.contains('active')) {
                            menu.classList.remove('active');
                        }
                    });
                    
                    const dropdown = link.nextElementSibling;
                    dropdown.classList.toggle('active');
                });
            });

            document.querySelectorAll('.asistencia-form').forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const rut = this.getAttribute('data-rut');
                    const dia = this.getAttribute('data-dia');
                    const mes = this.getAttribute('data-mes');
                    const anio = this.getAttribute('data-anio');
                    const estado = this.querySelector('select[name="estado"]').value;
                    const comentario = this.querySelector('input[name="comentario"]').value;
                    const fecha = `${anio}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                    
                    fetch('/registrar_asistencia_ajax', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            RUT: rut,
                            fecha: fecha,
                            estado: estado,
                            comentario: comentario
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Asistencia registrada con Ã©xito!');
                            window.location.reload();
                        } else {
                            alert('Error al registrar la asistencia.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al registrar la asistencia.');
                    });
                });
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown-menu') && !e.target.closest('.open-dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
                        menu.classList.remove('active');
                    });
                }
            });
        });
    </script>
</body>
</html>
